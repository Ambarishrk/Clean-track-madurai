rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * CLEAN-TRACK SECURITY RULES - PROTOTYPING MODE
     *
     * Core Philosophy:
     * This ruleset enforces a strict role-based and geographical-ownership model tailored for the 
     * Madurai City Municipal Corporation. Access is primarily governed by a user's role 
     * (COMMISSIONER, ZONAL_OFFICER, WARD_SUPERVISOR) and their assigned scope (zoneId, wardId).
     *
     * Data Structure:
     * - Top-level collections are used for city-wide entities (Wards, Zones, Indicators).
     * - Transactional data (KPIs, Tasks, Alerts) are stored at the top level but include 
     *   denormalized 'wardId' and 'zoneId' fields to allow efficient, secure filtering without 
     *   recursive parent lookups.
     * - Personal data (Notifications) is stored in user-specific subcollections.
     *
     * Key Security Decisions:
     * - DBAC (Database-Based Access Control): User roles and scopes are retrieved from 
     *   the /users/{userId} document.
     * - Relational Integrity: On document creation, the rules enforce that 'wardId' or 
     *   'zoneId' matches the authenticated user's assigned scope.
     * - Immutability: Critical relational fields (wardId, zoneId, authorId) are immutable 
     *   after creation to prevent data being "moved" between administrative scopes.
     * - Prototyping Flexibility: Schema validation (data types/required fields) is omitted 
     *   to allow for rapid frontend iteration, focusing purely on authorization.
     */

    // --- HELPER FUNCTIONS ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Retrieves user data from the Firestore users collection for role/scope checks
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isCommissioner() {
      return isSignedIn() && getUserData().role == 'MUNICIPAL_COMMISSIONER';
    }

    function isZonalOfficer(zoneId) {
      let user = getUserData();
      return isSignedIn() && user.role == 'ZONAL_OFFICER' && user.zoneId == zoneId;
    }

    function isWardSupervisor(wardId) {
      let user = getUserData();
      return isSignedIn() && user.role == 'WARD_SUPERVISOR' && user.wardId == wardId;
    }

    // Helper to check access for scoped documents (KPIs, Tasks, etc.)
    function hasScopeAccess(data) {
      return isCommissioner() || 
             (data.zoneId != null && isZonalOfficer(data.zoneId)) || 
             (data.wardId != null && isWardSupervisor(data.wardId));
    }

    // --- COLLECTION RULES ---

    /**
     * @description Rules for user profiles. Users can read/write their own profiles; Commissioner can read/write all.
     * @path /users/{userId}
     * @allow Authenticated user (get, create, update) their own document; Commissioner (all).
     * @deny Unauthenticated access; one user updating another's role.
     * @principle Ownership and Role-based access.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isCommissioner();
      allow list: if isCommissioner();
      allow create: if isOwner(userId);
      allow update: if (isOwner(userId) && request.resource.data.role == resource.data.role) || isCommissioner();
      allow delete: if isCommissioner();

      /**
       * @description Private user notifications.
       * @path /users/{userId}/notifications/{notifId}
       * @allow User reading their own notifications (list, get, update).
       * @deny Reading other users' notifications.
       * @principle Path-based structural segregation.
       */
      match /notifications/{notifId} {
        allow get, list: if isOwner(userId) || isCommissioner();
        allow create: if isCommissioner(); // Notifications typically created by System/Admin
        allow update: if isOwner(userId) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
        allow delete: if isOwner(userId) || isCommissioner();
      }
    }

    /**
     * @description Administrative boundaries (Wards and Zones).
     * @path /wards/{wardId} and /zones/{zoneId}
     * @allow Read access for all staff; write access for Commissioner only.
     * @deny Public read; Officer/Supervisor writing to static admin data.
     * @principle Global read with admin-only writes.
     */
    match /wards/{wardId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isCommissioner();
    }

    match /zones/{zoneId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isCommissioner();
    }

    /**
     * @description KPI snapshots, collection trips, and toilet facilities (Geographically scoped data).
     * @path /kpi_snapshots/{id}, /collection_trips/{id}, /toilet_facilities/{id}
     * @allow Read/Write if user belongs to the ward or zone assigned to the document.
     * @deny Accessing data outside of assigned administrative scope.
     * @principle Scoped shared access via denormalized wardId/zoneId.
     */
    match /kpi_snapshots/{id} {
      allow get, list: if hasScopeAccess(resource.data);
      allow create: if isCommissioner() || isWardSupervisor(request.resource.data.wardId);
      allow update: if (resource != null && hasScopeAccess(resource.data)) && (request.resource.data.wardId == resource.data.wardId);
      allow delete: if isCommissioner();
    }

    match /collection_trips/{id} {
      allow get, list: if hasScopeAccess(resource.data);
      allow create: if isCommissioner() || isWardSupervisor(request.resource.data.wardId);
      allow update: if (resource != null && hasScopeAccess(resource.data)) && (request.resource.data.wardId == resource.data.wardId);
      allow delete: if isCommissioner();
    }

    match /toilet_facilities/{id} {
      allow get, list: if hasScopeAccess(resource.data);
      allow create: if isCommissioner() || isZonalOfficer(request.resource.data.zoneId);
      allow update: if (resource != null && hasScopeAccess(resource.data));
      allow delete: if isCommissioner();
    }

    /**
     * @description System alerts and tasks.
     * @path /alerts/{alertId} and /tasks/{taskId}
     * @allow Commissioner/Officers/Supervisors read within scope. Officers/Supervisors can update status.
     * @deny Writing to alerts outside of assigned ward/zone.
     * @principle Scope-based access with multi-role interaction.
     */
    match /alerts/{alertId} {
      allow get, list: if hasScopeAccess(resource.data);
      allow create: if isCommissioner(); // Alerts are usually system-generated
      allow update: if resource != null && (hasScopeAccess(resource.data) || resource.data.assignedTo == request.auth.uid);
      allow delete: if isCommissioner();
    }

    match /tasks/{taskId} {
      allow get, list: if hasScopeAccess(resource.data) || resource.data.assignedTo == request.auth.uid;
      allow create: if isCommissioner() || isZonalOfficer(request.resource.data.zoneId);
      allow update: if resource != null && (hasScopeAccess(resource.data) || resource.data.assignedTo == request.auth.uid);
      allow delete: if isCommissioner();
    }

    /**
     * @description Escalations of issues to higher authorities.
     * @path /escalations/{escalationId}
     * @allow Read within scope; Create by lower-level; Update by current assignee.
     * @deny Modifying an escalation if not assigned or not commissioner.
     * @principle Escalation workflow authorization.
     */
    match /escalations/{escalationId} {
      allow get, list: if hasScopeAccess(resource.data);
      allow create: if isWardSupervisor(request.resource.data.wardId) || isZonalOfficer(request.resource.data.zoneId);
      allow update: if resource != null && (isCommissioner() || resource.data.currentAssignee == request.auth.uid);
      allow delete: if isCommissioner();
    }

    /**
     * @description Global GFC certification indicators.
     * @path /gfc_indicators/{indicatorId}
     * @allow Read for all signed-in staff; Update for Commissioner only.
     * @deny Supervisors editing global certification metrics.
     * @principle Global read with admin-only writes.
     */
    match /gfc_indicators/{indicatorId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isCommissioner();
    }

    /**
     * @description Predictive alerts generated by analytics.
     * @path /predictive_alerts/{alertId}
     * @allow Scoped read for relevant officers; System-only creation (represented by Commissioner/Admin).
     * @deny Modification by ward supervisors.
     * @principle Scoped consumption of system-generated data.
     */
    match /predictive_alerts/{alertId} {
      allow get, list: if hasScopeAccess(resource.data);
      allow create: if isCommissioner();
      allow update: if resource != null && hasScopeAccess(resource.data) && request.resource.data.isAcknowledged != null;
      allow delete: if isCommissioner();
    }
  }
}